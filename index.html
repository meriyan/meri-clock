<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>Meri Clock</title>
Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
Â  <style>
Â  Â  /* Existing CSS styles from your code... */
Â  Â  body {
Â  Â  Â  font-family: "Poppins", sans-serif;
Â  Â  Â  background-color: #1a001f;
Â  Â  Â  color: #f7c6ff;
Â  Â  Â  text-align: center;
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  }
Â  Â  h1, h2, h3 {
Â  Â  Â  color: #ffb6ff;
Â  Â  }
Â  Â  .clock {
Â  Â  Â  font-size: 48px;
Â  Â  Â  margin: 20px 0;
Â  Â  Â  color: #ffb6ff;
Â  Â  Â  text-shadow: 0 0 10px #ff80c8;
Â  Â  }
Â  Â  .section {
Â  Â  Â  margin: 30px auto;
Â  Â  Â  padding: 20px;
Â  Â  Â  border: 1px solid #ff80c8;
Â  Â  Â  border-radius: 15px;
Â  Â  Â  width: 90%;
Â  Â  Â  max-width: 700px;
Â  Â  Â  box-shadow: 0 0 20px rgba(255, 182, 255, 0.2);
Â  Â  Â  background-color: rgba(255, 182, 255, 0.05);
Â  Â  }
Â  Â  button {
Â  Â  Â  background-color: #ff80c8;
Â  Â  Â  color: white;
Â  Â  Â  border: none;
Â  Â  Â  padding: 10px 20px;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  font-size: 16px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  margin: 5px;
Â  Â  Â  transition: 0.3s;
Â  Â  }
Â  Â  button:hover:not(:disabled) {
Â  Â  Â  background-color: #ff9ee0;
Â  Â  }
Â  Â  button:disabled {
Â  Â  Â  opacity: 0.5;
Â  Â  Â  cursor: not-allowed;
Â  Â  }
Â  Â  input, select {
Â  Â  Â  padding: 10px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  border: 1px solid #ff80c8;
Â  Â  Â  background-color: #2b0033;
Â  Â  Â  color: #f7c6ff;
Â  Â  Â  margin: 5px;
Â  Â  }
Â  Â  table {
Â  Â  Â  margin: 20px auto;
Â  Â  Â  border-collapse: collapse;
Â  Â  Â  width: 90%;
Â  Â  Â  max-width: 800px;
Â  Â  }
Â  Â  th, td {
Â  Â  Â  border: 1px solid #ff80c8;
Â  Â  Â  padding: 8px;
Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  th {
Â  Â  Â  background-color: #2b0033;
Â  Â  Â  color: #ffb6ff;
Â  Â  }
Â  Â  td {
Â  Â  Â  background-color: #1a001f;
Â  Â  }
Â  Â  .small-text {
Â  Â  Â  font-size: 14px;
Â  Â  Â  opacity: 0.8;
Â  Â  Â  margin-top: 5px;
Â  Â  }
Â  Â  #authSection {
Â  Â  Â  display: block; /* Initially visible */
Â  Â  }
Â  Â  #appContent {
Â  Â  Â  display: none; /* Initially hidden */
Â  Â  }
Â  </style>
</head>
<body>
Â  <h1>ðŸ’– Meriâ€™s Motivational Clock ðŸ’–</h1>
Â  <div class="clock" id="mainClock"></div>

Â  <div id="authSection" class="section">
Â  Â  <h2>Login / Sign Up</h2>
Â  Â  <input type="email" id="authEmail" placeholder="Email" required />
Â  Â  <input type="password" id="authPassword" placeholder="Password" required />
Â  Â  <button id="authBtn">Log In / Sign Up</button>
Â  Â  <button id="logoutBtn" disabled>Log Out</button>
Â  Â  <div id="authStatus" class="small-text">Please log in to use the app.</div>
Â  </div>

Â  <div id="appContent">
Â  Â  <div class="section">
Â  Â  Â  <h2>Clock In / Clock Out</h2>
Â  Â  Â  <input type="text" id="activityInput" placeholder="What are you doing?" />
Â  Â  Â  <select id="tagInput">
Â  Â  Â  Â  <option value="">No tag</option>
Â  Â  Â  Â  <option value="Study">Study</option>
Â  Â  Â  Â  <option value="Work">Work</option>
Â  Â  Â  Â  <option value="Fitness">Fitness</option>
Â  Â  Â  Â  <option value="Other">Other</option>
Â  Â  Â  </select>
Â  Â  Â  <input type="text" id="notesInput" placeholder="Notes (optional)" />
Â  Â  Â  <button id="clockInBtn">Clock In</button>
Â  Â  Â  <button id="clockOutBtn" disabled>Clock Out</button>
Â  Â  Â  <div id="clockStatus" class="small-text">Not currently clocked in.</div>
Â  Â  </div>

Â  Â  <div class="section">
Â  Â  Â  <h2>Entries</h2>
Â  Â  Â  <table>
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <th>Date</th>
Â  Â  Â  Â  Â  Â  <th>Start</th>
Â  Â  Â  Â  Â  Â  <th>End</th>
Â  Â  Â  Â  Â  Â  <th>Duration</th>
Â  Â  Â  Â  Â  Â  <th>Activity</th>
Â  Â  Â  Â  Â  Â  <th>Tag</th>
Â  Â  Â  Â  Â  Â  <th>Notes</th>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody id="entriesTable"></tbody>
Â  Â  Â  </table>
Â  Â  </div>

Â  Â  <div class="section">
Â  Â  Â  <h2>Creator Sessions</h2>
Â  Â  Â  <button id="startCreatorSocial">Start Creator (With Social)</button>
Â  Â  Â  <button id="startCreatorNoSocial">Start Creator (No Social)</button>
Â  Â  Â  <button id="stopCreator" disabled>Stop</button>
Â  Â  Â  <div class="small-text">Session Timer: <span id="creatorTimer">00:00</span></div>
Â  Â  </div>

Â  Â  <div class="section">
Â  Â  Â  <h2 id="monthTitle"></h2>
Â  Â  Â  <table>
Â  Â  Â  Â  <tbody id="timeSlotsTable"></tbody>
Â  Â  Â  </table>
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  // !!! REPLACE THESE WITH YOUR ACTUAL SUPABASE DETAILS !!!
Â  Â  const supabaseUrl = "https://YOUR_PROJECT_URL.supabase.co";Â 
Â  Â  const supabaseKey = "YOUR_SUPABASE_ANON_KEY";
Â  Â  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

Â  Â  // --- AUTHENTICATION LOGIC (NEW/FIXED) ---
Â  Â  const authBtn = document.getElementById("authBtn");
Â  Â  const logoutBtn = document.getElementById("logoutBtn");
Â  Â  const authEmail = document.getElementById("authEmail");
Â  Â  const authPassword = document.getElementById("authPassword");
Â  Â  const authStatus = document.getElementById("authStatus");
Â  Â  const appContent = document.getElementById("appContent");
Â  Â  const authSection = document.getElementById("authSection");
Â  Â Â 
Â  Â  // Function to check user status and update UI
Â  Â  async function checkAuthState() {
Â  Â  Â  const { data: { user } } = await supabase.auth.getUser();

Â  Â  Â  if (user) {
Â  Â  Â  Â  authSection.style.display = 'none';
Â  Â  Â  Â  appContent.style.display = 'block';
Â  Â  Â  Â  authStatus.textContent = `Logged in as: ${user.email}`;
Â  Â  Â  Â  logoutBtn.disabled = false;
Â  Â  Â  Â  // Now that user is logged in, load all user data
Â  Â  Â  Â  loadEntries();
Â  Â  Â  } else {
Â  Â  Â  Â  authSection.style.display = 'block';
Â  Â  Â  Â  appContent.style.display = 'none';
Â  Â  Â  Â  authStatus.textContent = "Please log in to use the app.";
Â  Â  Â  Â  logoutBtn.disabled = true;
Â  Â  Â  }
Â  Â  }

Â  Â  // Handle Log In / Sign Up
Â  Â  authBtn.addEventListener("click", async () => {
Â  Â  Â  const email = authEmail.value;
Â  Â  Â  const password = authPassword.value;

Â  Â  Â  if (!email || !password) {
Â  Â  Â  Â  alert("Please enter email and password.");
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  authBtn.disabled = true;

Â  Â  Â  // 1. Try to Sign In
Â  Â  Â  let { error } = await supabase.auth.signInWithPassword({ email, password });

Â  Â  Â  if (error) {
Â  Â  Â  Â  console.log("Sign In failed, attempting Sign Up:", error.message);
Â  Â  Â  Â  // 2. If Sign In fails (e.g., user not found), try to Sign Up
Â  Â  Â  Â  const { error: signUpError } = await supabase.auth.signUp({ email, password });

Â  Â  Â  Â  if (signUpError) {
Â  Â  Â  Â  Â  alert(`Authentication Error: ${signUpError.message}`);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  alert("Sign Up successful! Check your email for a confirmation link (if enabled).");
Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  alert("Login successful!");
Â  Â  Â  }

Â  Â  Â  authBtn.disabled = false;
Â  Â  Â  checkAuthState(); // Update the UI after auth attempt
Â  Â  });

Â  Â  // Handle Log Out
Â  Â  logoutBtn.addEventListener("click", async () => {
Â  Â  Â  const { error } = await supabase.auth.signOut();
Â  Â  Â  if (!error) {
Â  Â  Â  Â  alert("Logged out successfully.");
Â  Â  Â  Â  // Also reset local state
Â  Â  Â  Â  clockedIn = false;
Â  Â  Â  Â  creatorTimerActive = false;
Â  Â  Â  Â  stopCreatorTimer();
Â  Â  Â  Â  document.getElementById("entriesTable").innerHTML = "";
Â  Â  Â  Â  document.getElementById("clockStatus").textContent = "Not currently clocked in.";
Â  Â  Â  } else {
Â  Â  Â  Â  console.error("Logout error:", error);
Â  Â  Â  Â  alert("Logout failed.");
Â  Â  Â  }
Â  Â  Â  checkAuthState();
Â  Â  });

Â  Â  // --- CLOCK, DATA, AND EVENT HANDLERS (Adjusted to use auth) ---

Â  Â  // âœ… Flip Clock
Â  Â  function updateClock() {
Â  Â  Â  const now = new Date();
Â  Â  Â  document.getElementById("mainClock").textContent = now.toLocaleTimeString("en-GB");
Â  Â  }
Â  Â  setInterval(updateClock, 1000);
Â  Â  updateClock();

Â  Â  // âœ… Month + Year title
Â  Â  const monthNames = [
Â  Â  Â  "January","February","March","April","May","June","July","August","September","October","November","December"
Â  Â  ];
Â  Â  const today = new Date();
Â  Â  document.getElementById("monthTitle").textContent = `${monthNames[today.getMonth()]} ${today.getFullYear()}`;

Â  Â  // âœ… Generate 48 half-hour checkboxes
Â  Â  const table = document.getElementById("timeSlotsTable");
Â  Â  for (let h = 0; h < 24; h++) {
Â  Â  Â  const row = document.createElement("tr");
Â  Â  Â  for (let m = 0; m < 2; m++) {
Â  Â  Â  Â  const td = document.createElement("td");
Â  Â  Â  Â  const timeLabel = document.createTextNode(
Â  Â  Â  Â  Â  `${String(h).padStart(2, "0")}:${m === 0 ? "00" : "30"}`
Â  Â  Â  Â  );
Â  Â  Â  Â  const checkbox = document.createElement("input");
Â  Â  Â  Â  checkbox.type = "checkbox";
Â  Â  Â  Â  checkbox.checked = false; // unchecked by default
Â  Â  Â  Â  td.appendChild(timeLabel);
Â  Â  Â  Â  td.appendChild(document.createElement("br"));
Â  Â  Â  Â  td.appendChild(checkbox);
Â  Â  Â  Â  row.appendChild(td);
Â  Â  Â  }
Â  Â  Â  table.appendChild(row);
Â  Â  }

Â  Â  // âœ… Clock In / Out
Â  Â  let clockedIn = false;
Â  Â  let startTime;
Â  Â  const clockOutBtn = document.getElementById("clockOutBtn");
Â  Â  const clockInBtn = document.getElementById("clockInBtn");
Â  Â  const entriesTable = document.getElementById("entriesTable");

Â  Â  function formatDuration(ms) {
Â  Â  Â  const durationMin = Math.floor(ms / 60000);
Â  Â  Â  const h = Math.floor(durationMin / 60);
Â  Â  Â  const m = durationMin % 60;
Â  Â  Â  return `${h > 0 ? h + 'h ' : ''}${m}m`;
Â  Â  }

Â  Â  async function loadEntries() {
Â  Â  Â  const { data: { user } } = await supabase.auth.getUser();
Â  Â  Â  if (!user) return;

Â  Â  Â  const todayIso = new Date().toISOString().split("T")[0];
Â  Â  Â  const { data: logs, error } = await supabase
Â  Â  Â  Â  .from("logs")
Â  Â  Â  Â  .select("*")
Â  Â  Â  Â  .eq("user_id", user.id)
Â  Â  Â  Â  .eq("log_date", todayIso) // Filter for today's date
Â  Â  Â  Â  .order("start_time", { ascending: false });

Â  Â  Â  if (error) {
Â  Â  Â  Â  console.error("Error loading entries:", error);
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  entriesTable.innerHTML = "";
Â  Â  Â  logs.forEach(log => {
Â  Â  Â  Â  const s = new Date(log.start_time);
Â  Â  Â  Â  const e = log.end_time ? new Date(log.end_time) : null;
Â  Â  Â  Â  const duration = e ? formatDuration(e - s) : '...';

Â  Â  Â  Â  const row = `<tr>
Â  Â  Â  Â  Â  <td>${s.toLocaleDateString()}</td>
Â  Â  Â  Â  Â  <td>${s.toLocaleTimeString("en-GB")}</td>
Â  Â  Â  Â  Â  <td>${e ? e.toLocaleTimeString("en-GB") : '-'}</td>
Â  Â  Â  Â  Â  <td>${duration}</td>
Â  Â  Â  Â  Â  <td>${log.activity || ''}</td>
Â  Â  Â  Â  Â  <td>${log.tag || ''}</td>
Â  Â  Â  Â  Â  <td>${log.notes || ''}</td>
Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  entriesTable.innerHTML += row;
Â  Â  Â  });
Â  Â  }

Â  Â  clockInBtn.addEventListener("click", () => {
Â  Â  Â  if (!supabase.auth.currentUser) return alert("Please log in first.");
Â  Â  Â  if (clockedIn) return alert("Already clocked in!");
Â  Â  Â  clockedIn = true;
Â  Â  Â  startTime = new Date();
Â  Â  Â  clockInBtn.disabled = true;
Â  Â  Â  clockOutBtn.disabled = false;
Â  Â  Â  document.getElementById("clockStatus").textContent = "Clocked in at " + startTime.toLocaleTimeString("en-GB");
Â  Â  });

Â  Â  clockOutBtn.addEventListener("click", async () => {
Â  Â  Â  if (!clockedIn) return alert("Not clocked in!");
Â  Â  Â  clockedIn = false;
Â  Â  Â  const endTime = new Date();

Â  Â  Â  const activity = document.getElementById("activityInput").value;
Â  Â  Â  const tag = document.getElementById("tagInput").value;
Â  Â  Â  const notes = document.getElementById("notesInput").value;
Â  Â  Â  const durationMs = endTime - startTime;

Â  Â  Â  const { data: { user } } = await supabase.auth.getUser();

Â  Â  Â  await supabase.from("logs").insert([
Â  Â  Â  Â  {
Â  Â  Â  Â  Â  user_id: user?.id || null,
Â  Â  Â  Â  Â  activity,
Â  Â  Â  Â  Â  tag,
Â  Â  Â  Â  Â  notes,
Â  Â  Â  Â  Â  start_time: startTime.toISOString(),
Â  Â  Â  Â  Â  end_time: endTime.toISOString(),
Â  Â  Â  Â  Â  log_date: new Date().toISOString().split("T")[0],
Â  Â  Â  Â  },
Â  Â  Â  ]);

Â  Â  Â  loadEntries(); // Reload the table
Â  Â  Â Â 
Â  Â  Â  clockInBtn.disabled = false;
Â  Â  Â  clockOutBtn.disabled = true;
Â  Â  Â  document.getElementById("clockStatus").textContent = "Not currently clocked in.";
Â  Â  });

Â  Â  // âœ… Creator Clock Logic
Â  Â  let creatorTimerActive = false;
Â  Â  let creatorStartTime;
Â  Â  let creatorUsageType;
Â  Â  let creatorInterval;
Â  Â  const startCreatorSocialBtn = document.getElementById("startCreatorSocial");
Â  Â  const startCreatorNoSocialBtn = document.getElementById("startCreatorNoSocial");
Â  Â  const stopCreatorBtn = document.getElementById("stopCreator");


Â  Â  function updateCreatorButtons() {
Â  Â  Â  const disabled = creatorTimerActive || clockedIn;
Â  Â  Â  startCreatorSocialBtn.disabled = disabled;
Â  Â  Â  startCreatorNoSocialBtn.disabled = disabled;
Â  Â  Â  stopCreatorBtn.disabled = !creatorTimerActive;
Â  Â  Â  clockInBtn.disabled = clockedIn || creatorTimerActive;
Â  Â  }

Â  Â  function startCreatorTimer() {
Â  Â  Â  creatorStartTime = new Date();
Â  Â  Â  creatorInterval = setInterval(() => {
Â  Â  Â  Â  const diff = Math.floor((new Date() - creatorStartTime) / 1000);
Â  Â  Â  Â  const min = String(Math.floor(diff / 60)).padStart(2, "0");
Â  Â  Â  Â  const sec = String(diff % 60).padStart(2, "0");
Â  Â  Â  Â  document.getElementById("creatorTimer").textContent = `${min}:${sec}`;
Â  Â  Â  }, 1000);
Â  Â  Â  updateCreatorButtons();
Â  Â  }

Â  Â  function stopCreatorTimer() {
Â  Â  Â  clearInterval(creatorInterval);
Â  Â  Â  document.getElementById("creatorTimer").textContent = "00:00";
Â  Â  Â  updateCreatorButtons();
Â  Â  }

Â  Â  async function saveCreatorSession(startTime, endTime, usageType) {
Â  Â  Â  const { data: { user } } = await supabase.auth.getUser();
Â  Â  Â  if (!user) { alert("No user logged in to save session!"); return; }

Â  Â  Â  try {
Â  Â  Â  Â  const { error } = await supabase.from("social_sessions").insert([
Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  user_id: user.id,
Â  Â  Â  Â  Â  Â  start_time: startTime.toISOString(),
Â  Â  Â  Â  Â  Â  end_time: endTime.toISOString(),
Â  Â  Â  Â  Â  Â  usage_type: usageType,
Â  Â  Â  Â  Â  Â  session_date: new Date().toISOString().split("T")[0],
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  ]);

Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  console.error("Save creator session failed:", error);
Â  Â  Â  Â  Â  alert(`Save creator session failed: ${error.message}`);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  console.log("Creator session saved successfully.");
Â  Â  Â  Â  }
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error("Unexpected error:", err);
Â  Â  Â  Â  alert("Unexpected error saving creator session.");
Â  Â  Â  }
Â  Â  }

Â  Â  document.getElementById("startCreatorSocial").addEventListener("click", () => {
Â  Â  Â  if (!supabase.auth.currentUser) return alert("Please log in first.");
Â  Â  Â  if (clockedIn) return alert("Please Clock Out before starting a Creator Session.");
Â  Â  Â  if (creatorTimerActive) return;
Â  Â  Â  creatorTimerActive = true;
Â  Â  Â  creatorUsageType = "With Social";
Â  Â  Â  startCreatorTimer();
Â  Â  });

Â  Â  document.getElementById("startCreatorNoSocial").addEventListener("click", () => {
Â  Â  Â  if (!supabase.auth.currentUser) return alert("Please log in first.");
Â  Â  Â  if (clockedIn) return alert("Please Clock Out before starting a Creator Session.");
Â  Â  Â  if (creatorTimerActive) return;
Â  Â  Â  creatorTimerActive = true;
Â  Â  Â  creatorUsageType = "No Social";
Â  Â  Â  startCreatorTimer();
Â  Â  });

Â  Â  document.getElementById("stopCreator").addEventListener("click", async () => {
Â  Â  Â  if (!creatorTimerActive) return;
Â  Â  Â  creatorTimerActive = false;
Â  Â  Â  const endTime = new Date();
Â  Â  Â  await saveCreatorSession(creatorStartTime, endTime, creatorUsageType);
Â  Â  Â  stopCreatorTimer();
Â  Â  Â  updateCreatorButtons(); // Re-enable Clock In
Â  Â  });

Â  Â  // --- INITIALIZATION ---
Â  Â  document.addEventListener("DOMContentLoaded", checkAuthState);
Â  </script>
</body>
</html>
