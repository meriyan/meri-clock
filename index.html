<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Meri — Daily Tracker</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
    --bg: #0d1117;
    --panel: #161b22;
    --card: #1f252d;
    --text: #c9d1d9;
    --accent: #58a6ff;
    --muted: #8b949e;
    --good: #3fb950;
    --warn: #d29922;
    --danger: #f85149;
    --pink: #ff69b4;
    --shadow: rgba(0,0,0,0.5);
}
html,body{
    height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
}
.container{min-height:100%;display:flex;flex-direction:column;align-items:center;padding:30px 20px 80px;}
.card{background:var(--card);border:1px solid var(--panel);border-radius:16px;
    box-shadow:0 10px 30px var(--shadow);padding:20px;max-width:1000px;width:100%;
    margin-top:25px;transition:transform .2s;}
.section-title{font-weight:700;letter-spacing:.08em;text-transform:uppercase;
    font-size:14px;color:var(--accent);margin:0 0 15px;border-bottom:2px solid var(--panel);padding-bottom:8px;}
.controls{display:flex;gap:15px;flex-wrap:wrap;align-items:center;justify-content:center;}
.btn{background:var(--panel);color:var(--text);border:none;border-radius:8px;
    padding:12px 18px;font-weight:500;cursor:pointer;transition:all .2s ease;}
.btn:hover:not(:disabled){background-color:var(--card);box-shadow:0 0 0 2px var(--accent);}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--pink));color:#fff;}
.btn.success{background:var(--good);color:#fff;}
.btn.warn{background:var(--warn);color:var(--bg);}
.btn.ghost{background:transparent;border:1px solid var(--muted);}
.btn:disabled{opacity:.4;cursor:not-allowed;}
.form{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
.form input,.form select,.form textarea{
    background:var(--panel);color:var(--text);border:1px solid #30363d;
    border-radius:8px;padding:10px 12px;outline:none;flex-grow:1;min-width:150px;
}
.form input:focus,.form select:focus,.form textarea:focus{
    border-color:var(--accent);box-shadow:0 0 0 1px var(--accent);
}
#notes{flex-basis:100%;resize:vertical;min-height:80px;}
#clockInStatus{font-weight:600;color:var(--good);font-size:1em;margin-top:15px;
    padding:8px;background:rgba(63,185,80,.1);border-radius:8px;}
.clock{text-align:center;font-size:48px;font-weight:700;color:var(--accent);}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:.9em;}
th,td{padding:12px 10px;text-align:left;border-bottom:1px solid #30363d;}
thead th{font-size:11px;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);}
tbody tr:hover{background-color:rgba(90,166,255,.05);}
.mini-timer{font-weight:800;font-variant-numeric:tabular-nums;color:var(--accent);}
.slot{display:flex;align-items:center;justify-content:space-between;background:var(--panel);
    padding:10px 12px;border-radius:6px;}
.slot:hover{background:#262e38;}
.chart-container{margin-top:20px;}
@media(max-width:600px){
 .card{padding:15px;margin-top:15px;}
 .clock{font-size:36px;}
}
</style>
</head>

<body>
<div class="container">

<!-- Auth -->
<div id="authSection" class="card">
 <div class="section-title">Log in or Sign up</div>
 <form id="authForm" class="form">
  <input type="email" id="authEmail" placeholder="Email" required>
  <input type="password" id="authPassword" placeholder="Password" required>
  <button class="btn primary" type="submit">Continue</button>
 </form>
</div>

<div id="dateSelectorPage" class="date-selector">
 <h2>Select Date</h2>
 <div id="dateSelector"></div>
</div>

<div id="mainApp">
 <div class="controls">
  <button id="logoutBtn" class="btn ghost">Log out</button>
 </div>

 <h2 id="selectedDateHeader" style="text-align:center;margin-top:10px;"></h2>

 <!-- Clock -->
 <div class="card">
  <div class="section-title">Clock</div>
  <div class="clock" id="clockDisplay"></div>
 </div>

 <!-- Clock In/Out -->
 <div class="card">
  <div class="section-title">Clock In / Clock Out</div>
  <form class="form" onsubmit="return false;">
   <input type="text" id="activity" placeholder="What are you doing?" required>
   <select id="category">
     <option value="">No tag</option>
     <option>Study</option><option>Work</option><option>Gym</option>
     <option>Deep Work</option><option>Content</option><option>Admin</option>
   </select>
   <textarea id="notes" placeholder="Notes (optional)"></textarea>
   <button id="clockInBtn" class="btn success" type="button">Clock In</button>
   <button id="clockOutBtn" class="btn warn" type="button" disabled>Clock Out</button>
  </form>
  <div id="clockInStatus" style="margin-top:10px;color:var(--muted);">Not currently clocked in.</div>
 </div>

 <!-- Regular Entries -->
 <div class="card">
  <div class="section-title">Entries</div>
  <table>
   <thead><tr><th>Date</th><th>Start</th><th>End</th><th>Duration</th><th>Activity</th><th>Tag</th><th>Notes</th></tr></thead>
   <tbody id="entriesBody"></tbody>
  </table>
 </div>

 <!-- Creator Zone -->
 <div class="card">
  <div class="section-title">Focus Zone — Creator Sessions & 30-min Checks</div>
  <div class="form" style="align-items:center;">
   <button id="creatorWithBtn" class="btn primary" type="button">Start Creator (With Social)</button>
   <button id="creatorNoBtn" class="btn success" type="button">Start Creator (No Social)</button>
   <button id="creatorStopBtn" class="btn warn" type="button" disabled>Stop</button>
   <span style="margin-left:10px;">Session Timer: <span id="miniTimer" class="mini-timer">00:00</span></span>
  </div>
  <div id="creatorStatus" style="margin-top:6px;color:var(--muted);font-style:italic;">No active session.</div>

  <div id="slotsGrid"
   style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;margin-top:12px;">
  </div>

  <!-- Chart -->
  <div class="chart-container">
   <canvas id="checkboxChart" height="150"></canvas>
  </div>
 </div>

 <!-- Creator Entries -->
 <div class="card">
  <div class="section-title">Creator Entries</div>
  <table>
   <thead><tr><th>Date</th><th>Start</th><th>End</th><th>Duration</th><th>Activity</th><th>Tag</th><th>Notes</th></tr></thead>
   <tbody id="creatorEntriesBody"></tbody>
  </table>
 </div>

</div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const SUPABASE_URL="https://eqqunclfxzmfosjwzwki.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxcXVuY2xmeHptZm9zand6d2tpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5NDg1MDQsImV4cCI6MjA3NzUyNDUwNH0.1N5pYTxFf6PjCMgQ0nUICsc9jLL58LuDZgX_s8yLe_w";
const supabase=createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const pad=n=>n.toString().padStart(2,"0");
const months=["January","February","March","April","May","June","July","August","September","October","November","December"];
let clockInInterval,creatorSessionInterval,creatorStartTime,chart;

function startOfDayUtc(d){const x=new Date(d.getFullYear(),d.getMonth(),d.getDate(),0,0,0);return new Date(x.getTime()-x.getTimezoneOffset()*60000);}
function nextDayUtc(d){const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()+1,0,0,0);return new Date(x.getTime()-x.getTimezoneOffset()*60000);}
async function getCurrentUser(){const {data:{user}}=await supabase.auth.getUser();return user;}

function tickClock(){const n=new Date();document.getElementById("clockDisplay").textContent=`${pad(n.getHours())}:${pad(n.getMinutes())}:${pad(n.getSeconds())}`;}

async function handleAuth(e){
 e.preventDefault();
 const email=document.getElementById("authEmail").value;
 const password=document.getElementById("authPassword").value;
 let {error}=await supabase.auth.signInWithPassword({email,password});
 if(error){
   const {error:e2}=await supabase.auth.signUp({email,password});
   if(e2)return alert("Auth error: "+e2.message);
   alert("Signup successful! Please log in.");
 } else alert("Login successful!");
 setupAfterLogin();
}

async function handleLogout(){await supabase.auth.signOut();localStorage.clear();location.reload();}

function buildDateSelector(){
 const c=document.getElementById("dateSelector");c.innerHTML="";
 const y=new Date().getFullYear(),m=new Date().getMonth();
 const yDiv=document.createElement("div");yDiv.className="year-box";yDiv.textContent=y;const grid=document.createElement("div");
 const days=new Date(y,m+1,0).getDate();
 for(let d=1;d<=days;d++){const b=document.createElement("div");b.className="day-btn";b.textContent=d;
   b.style.cssText="display:inline-block;margin:4px;padding:6px 10px;background:var(--panel);border-radius:6px;cursor:pointer;";
   b.onclick=()=>openDay(y,m,d);grid.appendChild(b);}
 c.appendChild(yDiv);c.appendChild(grid);
}

function openDay(y,m,d){
 const sel=new Date(y,m,d);
 localStorage.setItem("meri_selected_date",sel.toISOString());
 document.getElementById("dateSelectorPage").style.display="none";
 document.getElementById("mainApp").style.display="block";
 document.getElementById("selectedDateHeader").textContent=`${d} ${months[m]} ${y}`;
 window.currentDate=sel;setupDaily();
}

async function setupDaily(){
 const user=await getCurrentUser();if(!user)return;
 await loadEntries(user.id);await loadCreatorEntries(user.id);
 buildCheckboxGrid();await loadChecks();
 checkClockInStatus(user.id);
}

async function loadEntries(uid){
 const d=window.currentDate||new Date();const from=startOfDayUtc(d).toISOString();const to=nextDayUtc(d).toISOString();
 const {data}=await supabase.from("logs").select("*").eq("user_id",uid).gte("start_time",from).lt("start_time",to).order("start_time",{ascending:false});
 const tb=document.getElementById("entriesBody");tb.innerHTML="";
 data?.filter(r=>!r.activity?.startsWith("Creator Session")).forEach(r=>{
   const s=new Date(r.start_time);const e=r.end_time?new Date(r.end_time):null;
   tb.innerHTML+=`<tr><td>${pad(s.getDate())}.${pad(s.getMonth()+1)}.${s.getFullYear()}</td><td>${s.toLocaleTimeString()}</td><td>${e?e.toLocaleTimeString():"-"}</td><td>${e?formatDuration(e-s):""}</td><td>${r.activity||""}</td><td>${r.tag||""}</td><td>${r.notes||""}</td></tr>`;
 });
}
async function loadCreatorEntries(uid){
 const d=window.currentDate||new Date();const from=startOfDayUtc(d).toISOString();const to=nextDayUtc(d).toISOString();
 const {data}=await supabase.from("logs").select("*").eq("user_id",uid).gte("start_time",from).lt("start_time",to).order("start_time",{ascending:false});
 const tb=document.getElementById("creatorEntriesBody");tb.innerHTML="";
 data?.filter(r=>r.activity?.startsWith("Creator Session")).forEach(r=>{
   const s=new Date(r.start_time);const e=r.end_time?new Date(r.end_time):null;
   tb.innerHTML+=`<tr><td>${pad(s.getDate())}.${pad(s.getMonth()+1)}.${s.getFullYear()}</td><td>${s.toLocaleTimeString()}</td><td>${e?e.toLocaleTimeString():"-"}</td><td>${e?formatDuration(e-s):""}</td><td>${r.activity||""}</td><td>${r.tag||""}</td><td>${r.notes||""}</td></tr>`;
 });
}

function formatDuration(ms){const tot=Math.floor(ms/1000);const h=Math.floor(tot/3600),m=Math.floor((tot%3600)/60),s=tot%60;
 return (h>0?`${h}h `:"")+`${pad(m)}m${h==0?" "+pad(s)+"s":""}`;}

function buildCheckboxGrid(){
 const g=document.getElementById("slotsGrid");g.innerHTML="";
 for(let i=0;i<48;i++){
  const H=Math.floor(i/2),M=i%2===0?0:30;const lbl=`${pad(H)}:${pad(M)}`;
  const div=document.createElement("div");div.className="slot";
  div.innerHTML=`<span>${lbl}</span><input type="checkbox" data-label="${lbl}">`;
  g.appendChild(div);
 }
 g.onchange=toggleCheck;
}

async function loadChecks(){
 const user=await getCurrentUser();if(!user)return;
 const d=window.currentDate||new Date();const from=startOfDayUtc(d).toISOString();const to=nextDayUtc(d).toISOString();
 const {data}=await supabase.from("social_checks").select("slot_time,checked").eq("user_id",user.id).gte("slot_time",from).lt("slot_time",to);
 const map=new Map();data?.forEach(r=>{const t=new Date(r.slot_time);map.set(`${pad(t.getHours())}:${pad(t.getMinutes())}`,!!r.checked);});
 document.querySelectorAll("#slotsGrid input").forEach(cb=>{const l=cb.dataset.label;if(map.has(l))cb.checked=map.get(l);});
 updateChart();
}

async function toggleCheck(e){
 const cb=e.target;if(cb.tagName!=="INPUT")return;
 const user=await getCurrentUser();if(!user){cb.checked=!cb.checked;return alert("Login first");}
 const lbl=cb.dataset.label;const d=window.currentDate||new Date();
 const [H,M]=lbl.split(":").map(Number);const local=new Date(d.getFullYear(),d.getMonth(),d.getDate(),H,M);
 const slot=new Date(local.getTime()-local.getTimezoneOffset()*60000).toISOString();
 await supabase.from("social_checks").upsert({user_id:user.id,slot_time:slot,checked:cb.checked},{onConflict:"user_id,slot_time"});
 updateChart();
}

function updateChart(){
 const total=48;
 const checked=document.querySelectorAll("#slotsGrid input:checked").length;
 const percent=(checked/total*100).toFixed(1);
 const ctx=document.getElementById("checkboxChart").getContext("2d");
 if(chart)chart.destroy();
 chart=new Chart(ctx,{type:"doughnut",data:{labels:["Checked","Remaining"],
  datasets:[{data:[checked,total-checked],backgroundColor:["#ff69b4","#58a6ff"]}]},
  options:{plugins:{title:{display:true,text:`Today's Check Completion: ${percent}%`,color:"#c9d1d9"},legend:{labels:{color:"#c9d1d9"}}}}});
}

// Clock in/out logic (same as before)
async function handleClockIn(){
 const user=await getCurrentUser();if(!user)return alert("Please log in.");
 const activity=document.getElementById("activity").value;
 const tag=document.getElementById("category").value;
 const notes=document.getElementById("notes").value;
 const start_time=new Date().toISOString();
 await supabase.from("logs").insert({user_id:user.id,start_time,activity,tag,notes});
 localStorage.setItem("meri_clocked_in",start_time);
 localStorage.setItem("meri_clocked_in_activity",activity);
 localStorage.setItem("meri_clocked_in_tag",tag);
 localStorage.setItem("meri_clocked_in_notes",notes);
 checkClockInStatus(user.id);
 alert("Clocked in!");
}
async function handleClockOut(){
 const user=await getCurrentUser();if(!user)return;
 const startIso=localStorage.getItem("meri_clocked_in");
 const end_time=new Date().toISOString();
 const {data:logs}=await supabase.from("logs").select("id").eq("user_id",user.id).eq("start_time",startIso).is("end_time",null).limit(1);
 if(logs&&logs.length){await supabase.from("logs").update({end_time}).eq("id",logs[0].id);}
 localStorage.removeItem("meri_clocked_in");
 checkClockInStatus(user.id);await loadEntries(user.id);
 alert("Clocked out!");
}
function checkClockInStatus(){
 const st=localStorage.getItem("meri_clocked_in");
 const stat=document.getElementById("clockInStatus");
 if(st){stat.textContent="Currently Clocked In";document.getElementById("clockInBtn").disabled=true;document.getElementById("clockOutBtn").disabled=false;}
 else{stat.textContent="Not currently clocked in.";document.getElementById("clockInBtn").disabled=false;document.getElementById("clockOutBtn").disabled=true;}
}

// Creator Session
function updateMini(){if(!creatorStartTime)return;const el=document.getElementById("miniTimer");
 const diff=new Date()-creatorStartTime;const m=Math.floor(diff/60000),s=Math.floor((diff%60000)/1000);el.textContent=`${pad(m)}:${pad(s)}`;}
function startCreator(type){
 if(creatorSessionInterval)return;
 creatorStartTime=new Date();localStorage.setItem("creatorStart",creatorStartTime.toISOString());
 localStorage.setItem("creatorType",type);
 document.getElementById("creatorWithBtn").disabled=true;
 document.getElementById("creatorNoBtn").disabled=true;
 document.getElementById("creatorStopBtn").disabled=false;
 document.getElementById("creatorStatus").textContent=`Session Active: ${type==='social'?'With Social':'No Social'}`;
 updateMini();creatorSessionInterval=setInterval(updateMini,1000);
}
async function stopCreator(){
 if(!localStorage.getItem("creatorStart"))return;
 clearInterval(creatorSessionInterval);creatorSessionInterval=null;
 const user=await getCurrentUser();const type=localStorage.getItem("creatorType");
 const startIso=localStorage.getItem("creatorStart");const endIso=new Date().toISOString();
 const activity=`Creator Session (${type==='social'?'With Social':'No Social'})`;
 await supabase.from("logs").insert({user_id:user.id,start_time:startIso,end_time:endIso,activity,tag:"Deep Work",notes:"Completed"});
 localStorage.removeItem("creatorStart");localStorage.removeItem("creatorType");
 document.getElementById("creatorWithBtn").disabled=false;
 document.getElementById("creatorNoBtn").disabled=false;
 document.getElementById("creatorStopBtn").disabled=true;
 document.getElementById("creatorStatus").textContent="No active session.";document.getElementById("miniTimer").textContent="00:00";
 await loadCreatorEntries(user.id);
}

async function setupAfterLogin(){
 document.getElementById("authSection").style.display="none";
 document.getElementById("mainApp").style.display="block";
 const sel=localStorage.getItem("meri_selected_date")?new Date(localStorage.getItem("meri_selected_date")):new Date();
 window.currentDate=sel;
 document.getElementById("selectedDateHeader").textContent=`${sel.getDate()} ${months[sel.getMonth()]} ${sel.getFullYear()}`;
 setupDaily();
}

document.getElementById("authForm").onsubmit=handleAuth;
document.getElementById("logoutBtn").onclick=handleLogout;
document.getElementById("clockInBtn").onclick=handleClockIn;
document.getElementById("clockOutBtn").onclick=handleClockOut;
document.getElementById("creatorWithBtn").onclick=()=>startCreator("social");
document.getElementById("creatorNoBtn").onclick=()=>startCreator("no-social");
document.getElementById("creatorStopBtn").onclick=stopCreator;
setInterval(tickClock,1000);

const {data:{session}}=await supabase.auth.getSession();
if(!session?.user){document.getElementById("authSection").style.display="block";}
else setupAfterLogin();
buildDateSelector();
</script>
</body>
</html>
