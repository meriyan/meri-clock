<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Productivity â€“ Meri</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <style>
    :root{
      --bg:#0f1216; --panel:#151a21; --muted:#a9b1bb; --text:#e8eef6; --brand:#5b9cff; --ok:#30d158; --warn:#ffcc00; --danger:#ff453a;
      --ring: rgba(91,156,255,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#0e1114,#0b0e12); color:var(--text); font:14px/1.4 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;
    }

    /* ---- Layout (clean alignment) ---- */
    .wrap{
      max-width:1100px; margin:32px auto; padding:0 20px;
      display:grid; grid-template-columns: 1.1fr .9fr; gap:20px;
      align-items:start;
    }
    .full{grid-column:1/-1}
    .card{
      background:var(--panel); border:1px solid #1e2630; border-radius:16px; padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .card h2{margin:0 0 10px 0; font-size:16px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .stack{display:flex; flex-direction:column; gap:8px}
    .spacer{flex:1}
    .muted{color:var(--muted)}
    .divider{height:1px;background:#1f2833;margin:10px 0}

    /* inputs */
    input[type="text"], textarea, select, input[type="datetime-local"], input[type="date"]{
      background:#0f141a; border:1px solid #1f2833; color:var(--text); padding:10px 12px; border-radius:10px; outline:none; width:100%;
    }
    input[type="text"]:focus, textarea:focus, select:focus, input[type="date"]:focus{
      border-color:var(--brand); box-shadow:0 0 0 4px var(--ring);
    }
    button{
      background:#10151b; border:1px solid #263144; color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer;
      transition:.18s ease; font-weight:600;
    }
    button:hover{transform:translateY(-1px); border-color:#344253}
    .btn-brand{background:var(--brand); border-color:transparent; color:#0b1020}
    .btn-ok{background:var(--ok); color:#0a120b; border-color:transparent}
    .btn-ghost{background:transparent}
    .btn-danger{background:var(--danger); border-color:transparent; color:#fff}
    .pill{padding:6px 10px; border-radius:999px; background:#0e141b; border:1px solid #283241; color:var(--muted); font-weight:600}

    /* checks grid */
    .checks{
      display:grid; grid-template-columns: repeat(4, 1fr); gap:6px;
      max-height:430px; overflow:auto; padding-right:2px;
    }
    .slot{
      display:flex; align-items:center; gap:8px; padding:8px; border:1px solid #1f2833; border-radius:10px; background:#0f141a;
    }
    .slot input{accent-color:var(--ok)}
    .slot time{color:var(--muted); font-variant-numeric: tabular-nums}
    .sticky-header{
      position:sticky; top:0; background:linear-gradient(180deg,#151a21,#151a21 70%,rgba(21,26,33,0));
      padding-bottom:6px; z-index:5;
    }

    /* donut */
    .donut{
      --pct:0;
      width:160px; aspect-ratio:1; border-radius:50%;
      background:
        radial-gradient(closest-side,#151a21 68%,transparent 69% 100%),
        conic-gradient(var(--ok) calc(var(--pct)*1%), #263144 0);
      display:grid; place-items:center;
      box-shadow: inset 0 0 0 1px #223044;
    }
    .donut b{font-size:26px}
    .donut small{color:var(--muted)}
    .legend{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .legend .dot{width:10px; height:10px; border-radius:50%; background:var(--ok); box-shadow:0 0 0 2px #223044 inset}

    /* logs list */
    .list{display:flex; flex-direction:column; gap:8px; max-height:260px; overflow:auto}
    .item{border:1px solid #1f2833; border-radius:10px; padding:10px; background:#0f141a}
    .tag{padding:3px 8px; border-radius:999px; background:#0f1620; border:1px solid #223044; color:#9ec3ff; font-size:12px}

    @media (max-width: 900px){
      .wrap{grid-template-columns: 1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header / Date -->
    <div class="card full">
      <div class="row">
        <h2 style="margin-right:12px">Your Productivity HQ</h2>
        <span class="pill" id="todayPill">â€”</span>
        <div class="spacer"></div>
        <label class="muted">Pick date</label>
        <input id="datePicker" type="date" />
      </div>
      <div class="muted" style="margin-top:6px">Data is saved per day. Switch the date any time to view or update your history.</div>
    </div>

    <!-- Checks + donut -->
    <div class="card">
      <div class="sticky-header">
        <h2>Deep-Work Checks</h2>
        <div class="muted">30-minute slots for the selected day</div>
      </div>
      <div class="checks" id="checks"></div>
    </div>

    <div class="card stack" style="align-items:center">
      <h2>Progress</h2>
      <div class="donut" id="donut">
        <div class="stack" style="align-items:center">
          <b id="pct">0%</b>
          <small id="countLabel">0 / 48</small>
        </div>
      </div>
      <div class="legend"><span class="dot"></span><span class="muted">Completed slots</span></div>
    </div>

    <!-- Creator Session -->
    <div class="card stack">
      <h2>Creator Session</h2>
      <div class="row">
        <button class="btn-brand" id="startWith">Start â€” With Social</button>
        <button class="btn-ghost" id="startNo">Start â€” No Social</button>
        <button class="btn-ok" id="stopBtn">Stop</button>
        <div class="spacer"></div>
        <span class="muted" id="sessionState">Idle</span>
      </div>
      <div class="divider"></div>
      <div class="stack">
        <label class="muted">Recent Sessions (today)</label>
        <div class="list" id="sessionsList"></div>
      </div>
    </div>

    <!-- Quick Log -->
    <div class="card stack">
      <h2>Quick Log</h2>
      <div class="row" style="gap:8px">
        <input id="logActivity" type="text" placeholder="What did you do?" />
        <select id="logTag">
          <option value="Deep Work">Deep Work</option>
          <option value="Admin">Admin</option>
          <option value="Study">Study</option>
          <option value="Workout">Workout</option>
        </select>
      </div>
      <textarea id="logNotes" rows="3" placeholder="Notes (optional)"></textarea>
      <div class="row">
        <button class="btn-brand" id="addLog">Add Entry</button>
        <div class="spacer"></div>
        <button class="btn-ghost" id="refreshLogs">Refresh</button>
      </div>
      <div class="divider"></div>
      <div class="list" id="logsList"></div>
    </div>

    <!-- Footer -->
    <div class="card full" style="text-align:center;color:var(--muted)">
      Built for you ðŸš€ â€” data lives in <b>public.social_checks</b>, <b>public.social_sessions</b>, and <b>public.logs</b>.
    </div>
  </div>

<script>
/** ------------------------------
 *  CONFIG
 *  ------------------------------ */
const SUPABASE_URL = "https://YOUR_PROJECT_ID.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";
const USER_ID = "YOUR_USER_UUID"; // e.g. f83994bb-9224-48a4-b2e1-f5c7bb622a53

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/** ------------------------------
 *  STATE
 *  ------------------------------ */
const dom = {
  datePicker: document.getElementById('datePicker'),
  todayPill: document.getElementById('todayPill'),
  checks: document.getElementById('checks'),
  donut: document.getElementById('donut'),
  pct: document.getElementById('pct'),
  countLabel: document.getElementById('countLabel'),
  startWith: document.getElementById('startWith'),
  startNo: document.getElementById('startNo'),
  stopBtn: document.getElementById('stopBtn'),
  sessionState: document.getElementById('sessionState'),
  sessionsList: document.getElementById('sessionsList'),
  addLog: document.getElementById('addLog'),
  logActivity: document.getElementById('logActivity'),
  logTag: document.getElementById('logTag'),
  logNotes: document.getElementById('logNotes'),
  refreshLogs: document.getElementById('refreshLogs'),
  logsList: document.getElementById('logsList'),
};

// persist selected date
const keyDate = "meri.productivity.selectedDate";
const keyActiveSession = "meri.productivity.activeSession"; // {id, usage_type, start_time}

/** utils */
const pad = n => String(n).padStart(2,"0");
function toLocalDateStr(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function dayBounds(dateStr){
  const start = new Date(dateStr+"T00:00:00");
  const end = new Date(start); end.setDate(end.getDate()+1);
  return {start, end};
}
function fmtTime(ts){
  const d = new Date(ts);
  return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function setDonut(done,total){
  const pct = total ? Math.round((done/total)*100) : 0;
  dom.donut.style.setProperty('--pct', pct);
  dom.pct.textContent = `${pct}%`;
  dom.countLabel.textContent = `${done} / ${total}`;
}

/** ------------------------------
 *  DATE INIT
 *  ------------------------------ */
(function initDate(){
  const stored = localStorage.getItem(keyDate);
  const today = toLocalDateStr(new Date());
  dom.datePicker.value = stored || today;
  dom.todayPill.textContent = `Viewing: ${dom.datePicker.value}`;
  loadDay(dom.datePicker.value);
})();
dom.datePicker.addEventListener('change', () => {
  const val = dom.datePicker.value;
  localStorage.setItem(keyDate, val);
  dom.todayPill.textContent = `Viewing: ${val}`;
  loadDay(val);
});

/** ------------------------------
 *  LOAD A DAY
 *  ------------------------------ */
async function loadDay(dateStr){
  await Promise.all([
    renderChecks(dateStr),
    renderSessions(dateStr),
    renderLogs(dateStr),
  ]);
}

/** ------------------------------
 *  CHECKBOXES (social_checks)
 *  ------------------------------ */
async function fetchChecksForDay(dateStr){
  const {start, end} = dayBounds(dateStr);
  const { data, error } = await sb
    .from('social_checks')
    .select('id, slot_time, checked')
    .eq('user_id', USER_ID)
    .gte('slot_time', start.toISOString())
    .lt('slot_time', end.toISOString())
    .order('slot_time', { ascending: true });
  if(error){ console.error(error); return []; }
  return data || [];
}

async function upsertCheck(slotTimeISO, checked){
  // Try update existing by unique pair (user_id + slot_time). If none, insert.
  const { data: existing, error: err1 } = await sb
    .from('social_checks')
    .select('id')
    .eq('user_id', USER_ID)
    .eq('slot_time', slotTimeISO)
    .limit(1)
    .maybeSingle();
  if(err1){ console.error(err1); }

  if(existing){
    const { error } = await sb.from('social_checks').update({ checked })
      .eq('id', existing.id);
    if(error) console.error(error);
  }else{
    const { error } = await sb.from('social_checks').insert({
      user_id: USER_ID,
      slot_time: slotTimeISO,
      checked,
      check_date: slotTimeISO.slice(0,10) // if your schema keeps a date column
    });
    if(error) console.error(error);
  }
}

async function renderChecks(dateStr){
  dom.checks.innerHTML = '';
  // build all 48 slots
  const base = new Date(dateStr+"T00:00:00");
  const slots = [];
  for(let i=0;i<48;i++){
    const d = new Date(base.getTime() + i*30*60*1000);
    slots.push(d);
  }
  // fetch existing
  const existing = await fetchChecksForDay(dateStr);
  const map = new Map(existing.map(r => [new Date(r.slot_time).toISOString(), r.checked]));

  let done = 0;
  slots.forEach(d => {
    const iso = d.toISOString();
    const checked = !!map.get(iso);
    if(checked) done++;

    const el = document.createElement('label');
    el.className = 'slot';
    el.innerHTML = `
      <input type="checkbox" ${checked ? 'checked':''} />
      <time>${pad(d.getHours())}:${pad(d.getMinutes())}</time>
    `;
    const cb = el.querySelector('input');
    cb.addEventListener('change', async () => {
      await upsertCheck(iso, cb.checked);
      // update donut quickly without refetch
      const prev = map.get(iso) || false;
      map.set(iso, cb.checked);
      if(cb.checked && !prev) done++;
      if(!cb.checked && prev) done--;
      setDonut(done, 48);
    });
    dom.checks.appendChild(el);
  });

  setDonut(done, 48);
}

/** ------------------------------
 *  CREATOR SESSIONS (social_sessions)
 *  ------------------------------ */
function setSessionUI(active){
  if(active){
    dom.sessionState.textContent = `Running: ${active.usage_type.replace('_',' ')}, since ${fmtTime(active.start_time)}`;
    dom.startWith.disabled = true;
    dom.startNo.disabled = true;
    dom.stopBtn.disabled = false;
  }else{
    dom.sessionState.textContent = 'Idle';
    dom.startWith.disabled = false;
    dom.startNo.disabled = false;
    dom.stopBtn.disabled = false;
  }
}
function getActiveSession(){
  try{ return JSON.parse(localStorage.getItem(keyActiveSession) || 'null'); }
  catch{ return null; }
}
function setActiveSession(s){
  if(s) localStorage.setItem(keyActiveSession, JSON.stringify(s));
  else localStorage.removeItem(keyActiveSession);
  setSessionUI(s);
}

async function startSession(usage_type){
  // close any dangling open session (failsafe)
  await stopSession(true);
  const start = new Date().toISOString();
  const { data, error } = await sb.from('social_sessions')
    .insert({ user_id: USER_ID, usage_type, start_time: start })
    .select('id,start_time,usage_type').single();
  if(error){ console.error(error); alert('Could not start session'); return; }
  setActiveSession(data);
  await renderSessions(dom.datePicker.value);
}
async function stopSession(silent=false){
  let active = getActiveSession();
  if(!active){
    // try to find open row (end_time is null)
    const { data, error } = await sb.from('social_sessions')
      .select('id,start_time,usage_type')
      .eq('user_id', USER_ID)
      .is('end_time', null)
      .order('start_time', { ascending:false })
      .limit(1)
      .maybeSingle();
    if(error){ console.error(error); }
    if(data) active = data;
  }
  if(!active) { if(!silent) alert('No running session'); return; }

  const end = new Date().toISOString();
  const { error } = await sb.from('social_sessions')
    .update({ end_time: end })
    .eq('id', active.id);
  if(error){ console.error(error); if(!silent) alert('Could not stop session'); return; }

  setActiveSession(null);
  if(!silent) await renderSessions(dom.datePicker.value);
}

dom.startWith.addEventListener('click', () => startSession('with_social'));
dom.startNo.addEventListener('click', () => startSession('no_social'));
dom.stopBtn.addEventListener('click', () => stopSession(false));

// restore UI on load
setSessionUI(getActiveSession());

async function renderSessions(dateStr){
  const {start, end} = dayBounds(dateStr);
  const { data, error } = await sb.from('social_sessions')
    .select('id,start_time,end_time,usage_type')
    .eq('user_id', USER_ID)
    .gte('start_time', start.toISOString())
    .lt('start_time', end.toISOString())
    .order('start_time',{ascending:false});
  if(error){ console.error(error); return; }
  dom.sessionsList.innerHTML = '';
  (data||[]).forEach(s => {
    const dur = s.end_time ? (new Date(s.end_time)-new Date(s.start_time)) : 0;
    const mins = Math.round(dur/60000);
    const el = document.createElement('div');
    el.className='item';
    el.innerHTML = `
      <div class="row">
        <span class="tag">${s.usage_type.replace('_',' ')}</span>
        <div class="spacer"></div>
        <span class="muted">${fmtTime(s.start_time)} â€“ ${s.end_time ? fmtTime(s.end_time) : 'â€¦'}</span>
      </div>
      <div class="muted">${s.end_time ? `${mins} min` : 'Running'}</div>
    `;
    dom.sessionsList.appendChild(el);
  });
}

/** ------------------------------
 *  LOGS (public.logs)
 *  ------------------------------ */
dom.addLog.addEventListener('click', async () => {
  const activity = dom.logActivity.value.trim();
  if(!activity) return;
  const tag = dom.logTag.value;
  const notes = dom.logNotes.value.trim();
  const payload = { activity, tag, notes };
  const { error } = await sb.from('logs').insert(payload);
  if(error){ console.error(error); alert('Could not add log'); return; }
  dom.logActivity.value = '';
  dom.logNotes.value = '';
  renderLogs(dom.datePicker.value);
});
dom.refreshLogs.addEventListener('click', () => renderLogs(dom.datePicker.value));

async function renderLogs(dateStr){
  dom.logsList.innerHTML = '';
  // If you have created_at, filter by the day. Otherwise just show the latest 20.
  const {start, end} = dayBounds(dateStr);

  let query = sb.from('logs')
    .select('id, activity, tag, notes, created_at')
    .order('id', { ascending:false })
    .limit(50);

  // We try date filter if created_at exists.
  try{
    query = query.gte('created_at', start.toISOString()).lt('created_at', end.toISOString());
  }catch(e){ /* ignore */ }

  const { data, error } = await query;
  if(error){ console.error(error); return; }

  (data||[]).forEach(r => {
    const el = document.createElement('div');
    el.className='item';
    el.innerHTML = `
      <div class="row">
        <b>${r.activity || 'â€”'}</b>
        <div class="spacer"></div>
        ${r.tag ? `<span class="tag">${r.tag}</span>` : ''}
      </div>
      ${r.notes ? `<div class="muted" style="margin-top:6px">${r.notes}</div>` : ''}
      ${r.created_at ? `<div class="muted" style="margin-top:6px">${new Date(r.created_at).toLocaleString()}</div>` : ''}
    `;
    dom.logsList.appendChild(el);
  });
}
</script>
</body>
</html>


