<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meri Clock</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3"></script>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background-color: #1a001f;
      color: #f7c6ff;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1, h2, h3 { color: #ffb6ff; }
    .clock {
      font-size: 48px;
      margin: 20px 0;
      color: #ffb6ff;
      text-shadow: 0 0 10px #ff80c8;
    }
    .section {
      margin: 30px auto;
      padding: 20px;
      border: 1px solid #ff80c8;
      border-radius: 15px;
      width: 90%;
      max-width: 700px;
      box-shadow: 0 0 20px rgba(255, 182, 255, 0.2);
      background-color: rgba(255, 182, 255, 0.05);
    }
    button {
      background-color: #ff80c8;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
      transition: 0.3s;
    }
    button:hover { background-color: #ff9ee0; }
    input, select {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ff80c8;
      background-color: #2b0033;
      color: #f7c6ff;
    }
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 90%;
      max-width: 800px;
    }
    th, td {
      border: 1px solid #ff80c8;
      padding: 8px;
      text-align: center;
    }
    th { background-color: #2b0033; color: #ffb6ff; }
    td { background-color: #1a001f; }
    .small-text { font-size: 14px; opacity: 0.8; }
  </style>
</head>
<body>
  <!-- LOGIN BOX -->
  <div id="authBox" class="section" style="max-width:400px;">
    <h2>Login</h2>
    <input id="authEmail" type="email" placeholder="Email" style="width:90%;margin:4px;"><br>
    <input id="authPassword" type="password" placeholder="Password" style="width:90%;margin:4px;"><br>
    <button id="loginBtn">Login</button>
    <button id="signupBtn">Sign Up</button>
    <div id="authMsg" class="small-text"></div>
  </div>
  <button id="logoutBtn" style="display:none;position:fixed;top:16px;right:16px;">Logout</button>

  <!-- APP -->
  <div id="appContainer" style="display:none;">
    <h1>ðŸ’– Meriâ€™s Motivational Clock ðŸ’–</h1>
    <div class="clock" id="mainClock"></div>

    <div class="section">
      <h2>Select Date</h2>
      <input type="date" id="selectedDate" />
    </div>

    <div class="section">
      <h2>Clock In / Clock Out</h2>
      <input type="text" id="activityInput" placeholder="What are you doing?" />
      <select id="tagInput">
        <option value="">No tag</option>
        <option value="Study">Study</option>
        <option value="Work">Work</option>
        <option value="Fitness">Fitness</option>
        <option value="Other">Other</option>
      </select>
      <input type="text" id="notesInput" placeholder="Notes (optional)" />
      <button id="clockInBtn">Clock In</button>
      <button id="clockOutBtn">Clock Out</button>
      <div id="clockStatus" class="small-text">Not currently clocked in.</div>
    </div>

    <div class="section">
      <h2>Entries</h2>
      <table>
        <thead>
          <tr>
            <th>Date</th><th>Start</th><th>End</th><th>Duration</th>
            <th>Activity</th><th>Tag</th><th>Notes</th>
          </tr>
        </thead>
        <tbody id="entriesTable"></tbody>
      </table>
    </div>

    <div class="section">
      <h2>Creator Sessions</h2>
      <button id="startCreatorSocial">Start Creator (With Social)</button>
      <button id="startCreatorNoSocial">Start Creator (No Social)</button>
      <button id="stopCreator">Stop</button>
      <div class="small-text">Session Timer: <span id="creatorTimer">00:00</span></div>

      <table>
        <thead><tr><th>Date</th><th>Duration</th><th>Type</th></tr></thead>
        <tbody id="creatorEntriesTable"></tbody>
      </table>
    </div>

    <div class="section">
      <h2 id="monthTitle"></h2>
      <div class="small-text">Progress: <span id="progressPercent">0%</span></div>
      <progress id="progressBar" max="100" value="0" style="width:80%;height:12px;"></progress>
      <table><tbody id="timeSlotsTable"></tbody></table>
    </div>
  </div>

  <script>
  const supabaseUrl = "https://eqqunclfxzmfosjwzwki.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxcXVuY2xmeHptZm9zand6d2tpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5NDg1MDQsImV4cCI6MjA3NzUyNDUwNH0.1N5pYTxFf6PjCMgQ0nUICsc9jLL58LuDZgX_s8yLe_w";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  const TZ = "Europe/Berlin";
  const fmtTime = (d) => new Date(d).toLocaleTimeString("en-GB", { timeZone: TZ });
  const fmtDate = (d) => new Date(d).toLocaleDateString("en-GB", { timeZone: TZ });

  let currentUser = null;

  const authBox=document.getElementById("authBox");
  const appContainer=document.getElementById("appContainer");
  const authMsg=document.getElementById("authMsg");
  const loginBtn=document.getElementById("loginBtn");
  const signupBtn=document.getElementById("signupBtn");
  const logoutBtn=document.getElementById("logoutBtn");

  async function checkSession(){
    const { data } = await supabase.auth.getSession();
    const user = data.session?.user;
    if(user) showApp(user); else showLogin();
  }

  function showLogin(msg){
    authBox.style.display="";appContainer.style.display="none";logoutBtn.style.display="none";
    authMsg.textContent=msg||"";
  }

  function showApp(user){
    currentUser=user;
    authBox.style.display="none";appContainer.style.display="";logoutBtn.style.display="";
    loadDataForDate();
  }

  loginBtn.onclick=async()=>{
    const email=document.getElementById("authEmail").value.trim();
    const password=document.getElementById("authPassword").value;
    const {error}=await supabase.auth.signInWithPassword({email,password});
    if(error) authMsg.textContent="âŒ "+error.message; else checkSession();
  };

  signupBtn.onclick=async()=>{
    const email=document.getElementById("authEmail").value.trim();
    const password=document.getElementById("authPassword").value;
    const {error}=await supabase.auth.signUp({email,password});
    authMsg.textContent=error?error.message:"Check your email to confirm.";
  };

  logoutBtn.onclick=async()=>{await supabase.auth.signOut();showLogin("Logged out.");};

  supabase.auth.onAuthStateChange((_e,s)=>{if(s?.user)showApp(s.user);else showLogin();});
  checkSession();

  const dateInput=document.getElementById("selectedDate");
  const savedDate=localStorage.getItem("selectedDate");
  if(savedDate){
    dateInput.value=savedDate;
  }else{
    const t=new Date();
    const yyyy=t.getFullYear();
    const mm=String(t.getMonth()+1).padStart(2,"0");
    const dd=String(t.getDate()).padStart(2,"0");
    const localDate=`${yyyy}-${mm}-${dd}`;
    dateInput.value=localDate;localStorage.setItem("selectedDate",localDate);
  }
  dateInput.addEventListener("change",()=>{localStorage.setItem("selectedDate",dateInput.value);loadDataForDate();});

  function updateClock(){
    document.getElementById("mainClock").textContent=
      new Date().toLocaleTimeString("en-GB",{ timeZone: TZ });
  }
  setInterval(updateClock,1000);updateClock();

  const monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"];
  const now=new Date();document.getElementById("monthTitle").textContent=`${monthNames[now.getMonth()]} ${now.getFullYear()}`;

  const table=document.getElementById("timeSlotsTable");
  for(let h=0;h<24;h++){
    const row=document.createElement("tr");
    for(let m=0;m<2;m++){
      const td=document.createElement("td");
      const label=`${String(h).padStart(2,"0")}:${m===0?"00":"30"}`;
      const cb=document.createElement("input");
      cb.type="checkbox";cb.dataset.time=label;cb.onchange=()=>saveCheckbox(cb);
      td.append(label,document.createElement("br"),cb);row.appendChild(td);
    }table.appendChild(row);
  }

  async function loadCheckboxes(){
    if(!currentUser)return;
    const date=dateInput.value;
    const {data}=await supabase.from("social_checks").select("*").eq("user_id",currentUser.id).eq("check_date",date);
    const map={};(data||[]).forEach(r=>map[r.slot_time.substring(11,16)]=r.checked);
    document.querySelectorAll("#timeSlotsTable input").forEach(cb=>cb.checked=!!map[cb.dataset.time]);
    updateProgressBar();
  }

  // âœ… FIXED TIMEZONE LOGIC (Berlin DST-safe)
  async function saveCheckbox(cb) {
    const rawSlot = cb.dataset.time?.trim();
    const date = dateInput.value || new Date().toISOString().split("T")[0];
    const { data: { user } } = await supabase.auth.getUser();
    if (!user || !rawSlot || !/^\d{2}:\d{2}$/.test(rawSlot)) return;

    const localDateTime = new Date(`${date}T${rawSlot}:00`);
    const utcTime = new Date(localDateTime.getTime() - localDateTime.getTimezoneOffset() * 60000);
    const slot_time = utcTime.toISOString();

    try {
      const { error } = await supabase
        .from("social_checks")
        .upsert(
          {
            user_id: user.id,
            check_date: date,
            slot_time,
            checked: cb.checked
          },
          { onConflict: "user_id,check_date,slot_time" }
        );
      if (error) throw error;
    } catch (err) {
      console.error("saveCheckbox error:", err);
    }
  }

  function updateProgressBar(){
    const cbs=[...document.querySelectorAll("#timeSlotsTable input")];
    const checked=cbs.filter(c=>c.checked).length;
    const percent=Math.round((checked/cbs.length)*100);
    document.getElementById("progressPercent").textContent=percent+"%";
    document.getElementById("progressBar").value=percent;
  }

  async function loadLogs() {
    if (!currentUser) return;
    const date = dateInput.value;
    const { data } = await supabase
      .from("logs")
      .select("*")
      .eq("user_id", currentUser.id)
      .eq("log_date", date)
      .order("start_time");

    const tbody = document.getElementById("entriesTable");
    tbody.innerHTML = "";

    (data || []).forEach(l => {
      const durMs = new Date(l.end_time) - new Date(l.start_time);
      const mins = Math.floor(durMs / 60000);
      const dur = `${Math.floor(mins / 60)}h ${mins % 60}m`;

      const startLocal = fmtTime(l.start_time);
      const endLocal = fmtTime(l.end_time);
      const dateLocal = fmtDate(l.start_time);

      const row = `
        <tr>
          <td>${dateLocal}</td>
          <td>${startLocal}</td>
          <td>${endLocal}</td>
          <td>${dur}</td>
          <td>${l.activity || ""}</td>
          <td>${l.tag || ""}</td>
          <td>${l.notes || ""}</td>
        </tr>
      `;
      tbody.insertAdjacentHTML("beforeend", row);
    });
  }

  async function loadCreatorSessions() {
    if (!currentUser) return;
    const date = dateInput.value;
    const { data } = await supabase
      .from("social_sessions")
      .select("*")
      .eq("user_id", currentUser.id)
      .eq("session_date", date)
      .order("start_time");

    const tbody = document.getElementById("creatorEntriesTable");
    tbody.innerHTML = "";

    (data || []).forEach(s => {
      const durMs = new Date(s.end_time) - new Date(s.start_time);
      const mins = Math.floor(durMs / 60000);
      const secs = Math.floor((durMs % 60000) / 1000);
      const typeText = s.usage_type ? `(${s.usage_type.replace("_", " ")})` : "";
      const row = `<tr><td>${s.session_date}</td><td>${mins}m ${secs}s</td><td>${typeText}</td></tr>`;
      tbody.insertAdjacentHTML("beforeend", row);
    });
  }

  async function loadDataForDate(){
    await loadCheckboxes();
    await loadLogs();
    await loadCreatorSessions();
  }

  let clockedIn=false,startTime;
  document.getElementById("clockInBtn").onclick=()=>{
    if(clockedIn)return alert("Already clocked in!");
    clockedIn=true;startTime=new Date();
    document.getElementById("clockStatus").textContent="Clocked in at "+fmtTime(startTime);
  };
  document.getElementById("clockOutBtn").onclick=async()=>{
    if(!clockedIn)return alert("Not clocked in!");
    clockedIn=false;
    const endTime=new Date();
    const act=document.getElementById("activityInput").value;
    const tag=document.getElementById("tagInput").value;
    const notes=document.getElementById("notesInput").value;
    const date=dateInput.value;

    // âœ… FIXED: Convert to proper UTC before saving
    const startUtc = new Date(startTime.getTime() - startTime.getTimezoneOffset() * 60000).toISOString();
    const endUtc = new Date(endTime.getTime() - endTime.getTimezoneOffset() * 60000).toISOString();

    await supabase.from("logs").insert({
      user_id: currentUser.id,
      activity: act,
      tag,
      notes,
      start_time: startUtc,
      end_time: endUtc,
      log_date: date
    });

    await loadLogs();
    document.getElementById("clockStatus").textContent="Not currently clocked in.";
  };

  // Creator Session
  let creatorTimerActive = false, creatorStartTime, creatorUsageType, creatorInterval;

  function startCreatorTimer() {
    creatorStartTime = new Date();
    creatorInterval = setInterval(() => {
      const diff = Math.floor((new Date() - creatorStartTime) / 1000);
      const m = String(Math.floor(diff / 60)).padStart(2, "0");
      const s = String(diff % 60).padStart(2, "0");
      document.getElementById("creatorTimer").textContent = `${m}:${s}`;
    }, 1000);
  }

  function stopCreatorTimer() {
    clearInterval(creatorInterval);
    document.getElementById("creatorTimer").textContent = "00:00";
  }

  async function saveCreatorSession(start, end, type) {
    if (!currentUser) return;
    const date = dateInput.value;
    const normalizedType = type === "with_social" ? "with_social" : "no_social";

    const startUtc = new Date(start.getTime() - start.getTimezoneOffset() * 60000).toISOString();
    const endUtc = new Date(end.getTime() - end.getTimezoneOffset() * 60000).toISOString();


    const payload = {
      user_id: currentUser.id,
      start_time: startUtc,
      end_time: endUtc,
      usage_type: normalizedType,
      session_date: date
        };

    try {
      const { error } = await supabase
        .from("social_sessions")
        .insert(payload);

      if (error) throw error;
    } catch (err) {
      console.error("saveCreatorSession error:", err);
    }
  }

  // ---- Creator Session Buttons ----
  document.getElementById("startCreatorSocial").onclick = () => {
    if (creatorTimerActive) return;
    creatorTimerActive = true;
    creatorUsageType = "with_social";
    startCreatorTimer();
  };

  document.getElementById("startCreatorNoSocial").onclick = () => {
    if (creatorTimerActive) return;
    creatorTimerActive = true;
    creatorUsageType = "no_social";
    startCreatorTimer();
  };

  document.getElementById("stopCreator").onclick = async () => {
    if (!creatorTimerActive) return;
    creatorTimerActive = false;
    const end = new Date();
    stopCreatorTimer();
    await saveCreatorSession(creatorStartTime, end, creatorUsageType);
    await loadCreatorSessions();
  };

  // Load all data initially
  loadDataForDate();
  </script>
</body>
</html>
