<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meri — Flip Clock + Time Logger</title>

  <style>
    :root{ --bg:#0b0c10; --panel:#13161b; --card:#14161a; --text:#e8ecf1; --accent:#7aa7ff; --muted:#9aa3b2; --good:#3dcc7b; --warn:#ffc24d; --danger:#ff6b6b; --shadow:rgba(0,0,0,.4); }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .container{ min-height:100%; display:flex; flex-direction:column; gap:18px; align-items:center; padding:24px 20px 80px; }
    .grid{ width:100%; max-width:1100px; display:grid; grid-template-columns:1.1fr .9fr; gap:18px; }
    @media (max-width:940px){ .grid{ grid-template-columns:1fr; } }

    .controls{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center; }
    .chip, .btn{ background:var(--card); color:var(--text); border:1px solid rgba(255,255,255,.06); border-radius:10px; padding:10px 14px; box-shadow:0 8px 24px var(--shadow); cursor:pointer; user-select:none; }
    .btn.primary{ border-color: transparent; background:linear-gradient(180deg, var(--accent), #436cff); color:white; }
    .btn.success{ background:linear-gradient(180deg, var(--good), #1b8b52); color:white; border-color:transparent; }
    .btn.warn{ background:linear-gradient(180deg, var(--warn), #a37400); color:white; border-color:transparent; }
    .btn.ghost{ background:transparent; border:1px dashed rgba(255,255,255,.18); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .card{ background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:14px; box-shadow:0 16px 40px var(--shadow); padding:18px; }
    .section-title{ font-weight:700; letter-spacing:.04em; text-transform:uppercase; font-size:12px; color:var(--muted); margin:0 0 12px; }
    .date-line{ text-align:center; color:var(--muted); margin-top:4px; }

    .clock{ display:flex; gap:16px; align-items:center; justify-content:center; flex-wrap:wrap; }
    .digit{ font-size:68px; font-weight:800; }

    .form{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .form input, .form textarea, .form select{ background:var(--panel); color:var(--text); border:1px solid rgba(255,255,255,.06); border-radius:10px; padding:10px 12px; outline:none; min-width:160px; }
    .form textarea{ min-width:260px; min-height:40px; }

    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:10px 12px; text-align:left; border-bottom:1px solid rgba(255,255,255,.08); }
    thead th{ font-size:12px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); }

    .footer{ position:fixed; bottom:10px; left:0; right:0; display:flex; justify-content:center; color:var(--muted); font-size:12px; }
    .footer strong{ color:var(--text); }
  </style>
</head>

<body>
  <div class="container">
    <!-- AUTH -->
    <div id="authSection" class="card">
      <div class="section-title">Log in or Sign up</div>
      <form id="authForm">
        <input type="email" id="authEmail" placeholder="Email" required />
        <input type="password" id="authPassword" placeholder="Password" required />
        <button class="btn primary" type="submit">Continue</button>
      </form>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp">
      <div class="controls">
        <button id="logoutBtn" class="btn ghost">Log out</button>
      </div>

      <div class="grid">
        <div class="card">
          <div class="section-title">Flip Clock</div>
          <div id="clockDisplay" class="clock"></div>
        </div>

        <div class="card">
          <div class="section-title">Clock In / Clock Out</div>
          <form class="form" id="logForm" onsubmit="return false;">
            <input type="text" id="activity" placeholder="What are you doing?" required />
            <select id="category">
              <option value="">No tag</option>
              <option>Study</option>
              <option>Work</option>
              <option>Gym</option>
              <option>Deep Work</option>
              <option>Content</option>
              <option>Admin</option>
            </select>
            <textarea id="notes" placeholder="Notes (optional)"></textarea>
            <button id="clockInBtn" class="btn success" type="button">Clock In</button>
            <button id="clockOutBtn" class="btn warn" type="button">Clock Out</button>
          </form>
        </div>
      </div>

      <div class="card" style="width:100%; max-width:1100px;">
        <div class="section-title">Entries</div>
        <table id="entriesTable">
          <thead>
            <tr>
              <th>Date</th><th>Start</th><th>End</th><th>Activity</th><th>Tag</th><th>Notes</th>
            </tr>
          </thead>
          <tbody id="entriesBody"></tbody>
        </table>
      </div>
    </div>

    <div class="footer">Made for <strong>Meri</strong></div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://eqqunclfxzmfosjwzwki.supabase.co";
    const SUPABASE_ANON_KEY = "eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxcXVuY2xmeHptZm9zand6d2tpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5NDg1MDQsImV4cCI6MjA3NzUyNDUwNH0";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function updateClockButtons(isRunning) {
      document.getElementById("clockInBtn").disabled = isRunning;
      document.getElementById("clockOutBtn").disabled = !isRunning;
    }

    async function getCurrentUser() {
      const { data: { user } } = await supabase.auth.getUser();
      return user;
    }

    async function handleAuth(event) {
      event.preventDefault();
      const email = document.getElementById("authEmail").value;
      const password = document.getElementById("authPassword").value;
      let { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        const { error: signUpError } = await supabase.auth.signUp({ email, password });
        if (signUpError) return alert("Auth error: " + signUpError.message);
        alert("Signup successful! Check your email.");
      } else {
        alert("Login successful!");
      }
      setupAfterLogin();
    }

    async function handleLogout() {
      await supabase.auth.signOut();
      window.location.reload();
    }

    async function clockIn() {
      const user = await getCurrentUser();
      if (!user) return alert("Please log in first.");
      const activity = document.getElementById("activity").value.trim();
      const tag = document.getElementById("category").value;
      const notes = document.getElementById("notes").value.trim();
      const start_time = new Date().toISOString();
      const { error } = await supabase.from("logs").insert([{ user_id: user.id, activity, tag, notes, start_time }]);
      if (error) return alert("❌ " + error.message);
      alert("✅ Clocked in!");
      updateClockButtons(true);
      loadEntriesFromDB(user.id);
    }

    async function clockOut() {
      const user = await getCurrentUser();
      if (!user) return alert("Please log in first.");
      const activity = document.getElementById("activity").value.trim();
      const { error } = await supabase
        .from("logs")
        .update({ end_time: new Date().toISOString() })
        .eq("user_id", user.id)
        .eq("activity", activity)
        .is("end_time", null);
      if (error) return alert("❌ " + error.message);
      alert("⏰ Clocked out!");
      updateClockButtons(false);
      loadEntriesFromDB(user.id);
    }

    async function loadEntriesFromDB(userId) {
      const { data, error } = await supabase
        .from("logs")
        .select("*")
        .eq("user_id", userId)
        .order("start_time", { ascending: false });
      if (error) return console.error(error);
      const tbody = document.getElementById("entriesBody");
      tbody.innerHTML = "";
      data.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${fmtDate(r.start_time)}</td>
          <td>${fmtTime(r.start_time)}</td>
          <td>${r.end_time ? fmtTime(r.end_time) : "—"}</td>
          <td>${escapeHtml(r.activity)}</td>
          <td>${escapeHtml(r.tag)}</td>
          <td>${escapeHtml(r.notes)}</td>`;
        tbody.appendChild(tr);
      });
    }

    function fmtDate(d) {
      const date = new Date(d);
      return date.toLocaleDateString();
    }

    function fmtTime(t) {
      const date = new Date(t);
      return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }

    function escapeHtml(s = "") {
      return s.replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[c]));
    }

    // Flip Clock logic
    function updateClock() {
      const now = new Date();
      const h = String(now.getHours()).padStart(2, "0");
      const m = String(now.getMinutes()).padStart(2, "0");
      const s = String(now.getSeconds()).padStart(2, "0");
      document.getElementById("clockDisplay").innerHTML = `
        <span class="digit">${h}</span> : 
        <span class="digit">${m}</span> : 
        <span class="digit">${s}</span>`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    async function setupAfterLogin() {
      const user = await getCurrentUser();
      if (!user) return;
      document.getElementById("authSection").style.display = "none";
      document.getElementById("mainApp").style.display = "block";
      loadEntriesFromDB(user.id);
      updateClockButtons(false);
    }

    window.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("mainApp").style.display = "none";
      document.getElementById("authForm").addEventListener("submit", handleAuth);
      document.getElementById("logoutBtn").addEventListener("click", handleLogout);
      document.getElementById("clockInBtn").addEventListener("click", clockIn);
      document.getElementById("clockOutBtn").addEventListener("click", clockOut);

      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user) setupAfterLogin();
    });
  </script>
</body>
</html>
