<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meri — Daily Tracker</title>
  <style>
    :root {
      --bg:#0b0c10; --panel:#13161b; --card:#14161a; --text:#e8ecf1; --accent:#7aa7ff;
      --muted:#9aa3b2; --good:#3dcc7b; --warn:#ffc24d; --danger:#ff6b6b; --shadow:rgba(0,0,0,.4);
    }
    html,body {height:100%;margin:0;background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .container {min-height:100%;display:flex;flex-direction:column;align-items:center;padding:24px 20px 80px;}
    .card {background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:14px;
      box-shadow:0 16px 40px var(--shadow);padding:18px;max-width:1100px;width:100%;}
    .section-title {font-weight:700;letter-spacing:.04em;text-transform:uppercase;
      font-size:12px;color:var(--muted);margin:0 0 12px;}
    .controls {display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center;}
    .btn {background:var(--card);color:var(--text);border:1px solid rgba(255,255,255,.06);
      border-radius:10px;padding:10px 14px;box-shadow:0 8px 24px var(--shadow);cursor:pointer;user-select:none;}
    .btn.primary {background:linear-gradient(180deg, var(--accent), #436cff);color:white;border-color:transparent;}
    .btn.success {background:linear-gradient(180deg, var(--good), #1b8b52);color:white;border-color:transparent;}
    .btn.warn {background:linear-gradient(180deg, var(--warn), #a37400);color:white;border-color:transparent;}
    .btn.ghost {background:transparent;border:1px dashed rgba(255,255,255,.18);}
    .date-selector {display:flex;flex-direction:column;gap:12px;align-items:center;}
    .year-box,.month-box {background:var(--panel);border-radius:10px;padding:10px 16px;width:100%;max-width:400px;cursor:pointer;}
    .days-grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;width:100%;max-width:400px;margin-top:6px;}
    .day-btn {background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:8px;text-align:center;cursor:pointer;transition:.2s;}
    .day-btn:hover {background:var(--accent);color:white;}
    .clock {display:flex;gap:16px;align-items:center;justify-content:center;flex-wrap:wrap;}
    .segment {display:flex;gap:8px;}
    .colon {font-weight:800;font-size:48px;opacity:.75;position:relative;top:-8px;}
    .flip {position:relative;width:92px;height:120px;perspective:1000px;}
    .card-face {position:relative;width:100%;height:100%;border-radius:14px;
      background:linear-gradient(180deg, var(--card), #0f1116);border:1px solid rgba(255,255,255,.06);overflow:hidden;}
    .half {position:absolute;left:0;right:0;height:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-variant-numeric:tabular-nums;}
    .top {top:0;border-bottom:1px solid rgba(0,0,0,.35);}
    .bottom {bottom:0;}
    .digit {font-size:68px;}
    table {width:100%;border-collapse:separate;border-spacing:0;}
    th,td {padding:10px 12px;text-align:left;border-bottom:1px solid rgba(255,255,255,.08);}
    thead th {font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);}
    .form {display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .form input,.form select,.form textarea {background:var(--panel);color:var(--text);
      border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:10px 12px;outline:none;}
    .mini-timer {font-weight:800;font-variant-numeric:tabular-nums;}
    .slot {display:flex;align-items:center;justify-content:space-between;background:var(--panel);padding:8px 12px;border-radius:8px;}
  </style>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    // NOTE: These keys are placeholder public keys for this demo structure
    const SUPABASE_URL="https://eqqunclfxzmfosjwzwki.supabase.co";
    const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxcXVuY2xmeHptZm9zand6d2tpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5NDg1MDQsImV4cCI6MjA3NzUyNDUwNH0.1N5pYTxFf6PjCMgQ0nUICsc9jLL58LuDZgX_s8yLe_w";
    const supabase=createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

    const pad=n=>n.toString().padStart(2,"0");
    const months=["January","February","March","April","May","June","July","August","September","October","November","December"];
    let clockInInterval, creatorSessionInterval, creatorStartTime;

    function startOfDayUtc(d){const x=new Date(d.getFullYear(),d.getMonth(),d.getDate(),0,0,0);return new Date(x.getTime()-x.getTimezoneOffset()*60000);}
    function nextDayUtc(d){const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()+1,0,0,0);return new Date(x.getTime()-x.getTimezoneOffset()*60000);}
    async function getCurrentUser(){const {data:{user}}=await supabase.auth.getUser();return user;}

    async function handleAuth(e){
      e.preventDefault();
      const email=document.getElementById("authEmail").value;
      const password=document.getElementById("authPassword").value;
      let {error}=await supabase.auth.signInWithPassword({email,password});
      if(error){
        const {error:e2}=await supabase.auth.signUp({email,password});
        if(e2)return alert("Auth error: "+e2.message);
        alert("Signup successful! Please log in.");
      } else alert("Login successful!");
      setupAfterLogin();
    }

    async function handleLogout(){await supabase.auth.signOut();localStorage.removeItem("meri_selected_date");location.reload();}

    function buildDateSelector(){
      const c=document.getElementById("dateSelector");
      c.innerHTML="";
      for(let y=2025;y<=2030;y++){
        const yDiv=document.createElement("div");
        yDiv.className="year-box";
        yDiv.textContent=y;
        yDiv.addEventListener("click",()=>toggleMonths(yDiv,y));
        c.appendChild(yDiv);
      }
    }

    function toggleMonths(yDiv,year){
      let existing=yDiv.nextElementSibling;
      if(existing&&existing.classList.contains("month-container")){existing.remove();return;}
      const mC=document.createElement("div");
      mC.className="month-container";
      months.forEach((m,i)=>{
        const mDiv=document.createElement("div");
        mDiv.className="month-box";
        mDiv.textContent=m;
        mDiv.addEventListener("click",()=>toggleDays(mDiv,year,i));
        mC.appendChild(mDiv);
      });
      yDiv.after(mC);
    }

    function toggleDays(mDiv,year,month){
      let existing=mDiv.nextElementSibling;
      if(existing&&existing.classList.contains("days-grid")){existing.remove();return;}
      const grid=document.createElement("div");
      grid.className="days-grid";
      const days=new Date(year,month+1,0).getDate();
      for(let d=1;d<=days;d++){
        const b=document.createElement("div");
        b.className="day-btn";
        b.textContent=d;
        b.addEventListener("click",()=>openDay(year,month,d));
        grid.appendChild(b);
      }
      mDiv.after(grid);
    }

    function openDay(y,m,d){
      const sel=new Date(y,m,d);
      localStorage.setItem("meri_selected_date",sel.toISOString());
      document.getElementById("dateSelectorPage").style.display="none";
      document.getElementById("mainApp").style.display="block";
      document.getElementById("selectedDateHeader").textContent=`${d} ${months[m]} ${y}`;
      window.currentDate=sel;
      setupDaily();
    }

    async function setupDaily(){
      const user=await getCurrentUser(); if(!user)return;
      await loadEntries(user.id);
      buildCheckboxGrid(); await loadChecks();
      checkClockInStatus(user.id);
    }

    async function loadEntries(uid){
      const d=window.currentDate||new Date();
      const from=startOfDayUtc(d).toISOString();const to=nextDayUtc(d).toISOString();
      const {data}=await supabase.from("logs").select("*").eq("user_id",uid).gte("start_time",from).lt("start_time",to).order("start_time",{ascending:false});
      const tb=document.getElementById("entriesBody");tb.innerHTML="";
      data?.forEach(r=>{
        const s=new Date(r.start_time);const e=r.end_time?new Date(r.end_time):null;
        // Calculate duration in hours/minutes if end_time exists
        let duration = e ? formatDuration(e.getTime() - s.getTime()) : '';
        
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${pad(s.getDate())}.${pad(s.getMonth()+1)}.${s.getFullYear()}</td><td>${s.toLocaleTimeString()}</td><td>${e?e.toLocaleTimeString():"-"}</td><td>${duration}</td><td>${r.activity||""}</td><td>${r.tag||""}</td><td>${r.notes||""}</td>`;
        tb.appendChild(tr);
      });
    }

    function formatDuration(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        let output = "";
        if (hours > 0) output += `${hours}h `;
        output += `${minutes}m`;
        return output.trim();
    }

    function buildCheckboxGrid(){
      const g=document.getElementById("slotsGrid");g.innerHTML="";
      for(let i=0;i<48;i++){
        const H = Math.floor(i/2);
        const M = i%2===0?0:30;
        const lbl=`${pad(H)}:${pad(M)}`;
        const div=document.createElement("div");div.className="slot";
        div.innerHTML=`<span>${lbl}</span><input type="checkbox" data-label="${lbl}">`;
        g.appendChild(div);
      }
      g.addEventListener("change",toggleCheck);
    }

    async function loadChecks(){
      const user=await getCurrentUser();if(!user)return;
      const d=window.currentDate||new Date();
      const from=startOfDayUtc(d).toISOString();const to=nextDayUtc(d).toISOString();
      const {data}=await supabase.from("social_checks").select("slot_time,checked").eq("user_id",user.id).gte("slot_time",from).lt("slot_time",to);
      const map=new Map();data?.forEach(r=>{const t=new Date(r.slot_time);map.set(`${pad(t.getHours())}:${pad(t.getMinutes())}`,!!r.checked);});
      document.querySelectorAll("#slotsGrid input").forEach(cb=>{const l=cb.dataset.label;if(map.has(l))cb.checked=map.get(l);});
    }

    async function toggleCheck(e){
      const cb=e.target;if(cb.tagName!=="INPUT")return;
      const user=await getCurrentUser();if(!user){cb.checked=!cb.checked;return alert("Login first");}
      const lbl=cb.dataset.label;const d=window.currentDate||new Date();
      const [H,M]=lbl.split(":").map(Number);const local=new Date(d.getFullYear(),d.getMonth(),d.getDate(),H,M);
      const slot=new Date(local.getTime()-local.getTimezoneOffset()*60000).toISOString();
      await supabase.from("social_checks").upsert({user_id:user.id,slot_time:slot,checked:cb.checked},{onConflict:"user_id,slot_time"});
    }

    // Fix for the duplicate clock issue: The clock elements are now generated *only* here.
    function tickClock() {
      const n = new Date();
      const h = pad(n.getHours()), m = pad(n.getMinutes()), s = pad(n.getSeconds());

      // 1. Clear and recreate the clock structure (this is essential when the HTML structure is empty)
      //    This prevents duplication by overwriting the entire content every second.
      document.querySelector('.clock').innerHTML = `
        <div id="hoursSeg" class="segment"></div>
        <div class="colon">:</div>
        <div id="minsSeg" class="segment"></div>
        <div class="colon">:</div>
        <div id="secsSeg" class="segment"></div>
      `;

      // 2. Render the digits into the newly created segments
      renderDigits("hoursSeg", h);
      renderDigits("minsSeg", m);
      renderDigits("secsSeg", s);
    }

    function renderDigits(id,str){
      const seg=document.getElementById(id);
      if(!seg) return;
      seg.innerHTML="";
      for(const ch of str){
        const e=document.createElement("div");
        e.className="flip";
        e.innerHTML=`<div class="card-face"><div class="half top"><div class="digit">${ch}</div></div><div class="half bottom"><div class="digit">${ch}</div></div></div>`;
        seg.appendChild(e);
      }
    }
    
    // --- Clock In/Out Logic ---
    async function handleClockIn() {
        const user = await getCurrentUser(); if (!user) return alert("Please log in.");
        const activity = document.getElementById("activity").value;
        const tag = document.getElementById("category").value;
        const notes = document.getElementById("notes").value;
        if (!activity) return alert("Activity is required.");

        const start_time = new Date().toISOString();
        const { error } = await supabase.from("logs").insert({ user_id: user.id, start_time, activity, tag, notes, end_time: null });
        if (error) return alert("Clock In Error: " + error.message);
        
        localStorage.setItem("meri_clocked_in", start_time);
        localStorage.setItem("meri_clocked_in_activity", activity);
        localStorage.setItem("meri_clocked_in_tag", tag);
        localStorage.setItem("meri_clocked_in_notes", notes);
        
        checkClockInStatus(user.id);
        alert("Clocked In!");
    }

    async function handleClockOut() {
        const user = await getCurrentUser(); if (!user) return;
        const clockedInTime = localStorage.getItem("meri_clocked_in");
        if (!clockedInTime) return alert("You are not currently clocked in.");

        const end_time = new Date().toISOString();
        const activity = localStorage.getItem("meri_clocked_in_activity");
        const tag = localStorage.getItem("meri_clocked_in_tag");
        const notes = localStorage.getItem("meri_clocked_in_notes");

        // Find the last open log entry and update it
        const d = new Date(clockedInTime);
        const from = startOfDayUtc(d).toISOString();
        const { data: logs, error: selectError } = await supabase.from("logs")
            .select("id")
            .eq("user_id", user.id)
            .eq("start_time", clockedInTime)
            .is("end_time", null)
            .order("start_time", { ascending: false })
            .limit(1);

        if (selectError) return alert("Clock Out Error (Select): " + selectError.message);
        if (logs.length === 0) return alert("Could not find the start log entry.");

        const { error: updateError } = await supabase.from("logs")
            .update({ end_time, activity, tag, notes })
            .eq("id", logs[0].id);

        if (updateError) return alert("Clock Out Error (Update): " + updateError.message);

        localStorage.removeItem("meri_clocked_in");
        localStorage.removeItem("meri_clocked_in_activity");
        localStorage.removeItem("meri_clocked_in_tag");
        localStorage.removeItem("meri_clocked_in_notes");

        checkClockInStatus(user.id);
        await loadEntries(user.id); // Reload table
        alert("Clocked Out!");
    }

    function checkClockInStatus(uid) {
        const isClockedIn = localStorage.getItem("meri_clocked_in");
        document.getElementById("clockInBtn").disabled = !!isClockedIn;
        document.getElementById("clockOutBtn").disabled = !isClockedIn;
        document.getElementById("activity").value = localStorage.getItem("meri_clocked_in_activity") || '';
        document.getElementById("category").value = localStorage.getItem("meri_clocked_in_tag") || '';
        document.getElementById("notes").value = localStorage.getItem("meri_clocked_in_notes") || '';

        if (isClockedIn) {
            if (!clockInInterval) {
                clockInInterval = setInterval(() => {
                    // Update current entry display
                    const activity = localStorage.getItem("meri_clocked_in_activity");
                    const statusText = `Clocked In to: **${activity}** at ${new Date(isClockedIn).toLocaleTimeString()}`;
                    document.querySelector('#clockInStatus').innerHTML = statusText;
                }, 1000);
            }
        } else {
            if (clockInInterval) {
                clearInterval(clockInInterval);
                clockInInterval = null;
            }
            document.querySelector('#clockInStatus').innerHTML = "Not currently clocked in.";
        }
    }
    
    // --- Creator Session Logic ---
    function updateMiniTimer() {
        if (!creatorStartTime) return;
        const elapsed = new Date().getTime() - creatorStartTime.getTime();
        const totalSeconds = Math.floor(elapsed / 1000);
        const minutes = pad(Math.floor(totalSeconds / 60));
        const seconds = pad(totalSeconds % 60);
        document.getElementById("miniTimer").textContent = `${minutes}:${seconds}`;
    }

    function startCreator(type) {
        if (creatorSessionInterval) return alert("A session is already running. Please stop it first.");
        creatorStartTime = new Date();
        localStorage.setItem("meri_creator_session_start", creatorStartTime.toISOString());
        localStorage.setItem("meri_creator_session_type", type);

        document.getElementById("creatorWithBtn").disabled = true;
        document.getElementById("creatorNoBtn").disabled = true;
        document.getElementById("creatorStopBtn").disabled = false;
        
        document.getElementById("creatorStatus").textContent = `Session Active: ${type}`;
        
        creatorSessionInterval = setInterval(updateMiniTimer, 1000);
        updateMiniTimer();
    }

    async function stopCreator() {
        if (!creatorSessionInterval) return alert("No active session to stop.");
        clearInterval(creatorSessionInterval);
        creatorSessionInterval = null;
        
        const type = localStorage.getItem("meri_creator_session_type");
        const start = localStorage.getItem("meri_creator_session_start");
        
        // Log the session as a "Work" log entry
        const user = await getCurrentUser();
        if (user && start) {
            const end = new Date().toISOString();
            const activity = `Creator Session (${type === 'social' ? 'With Social' : 'No Social'})`;
            const tag = 'Deep Work';
            await supabase.from("logs").insert({ 
                user_id: user.id, 
                start_time: start, 
                end_time: end, 
                activity: activity, 
                tag: tag,
                notes: `Duration: ${formatDuration(new Date(end).getTime() - new Date(start).getTime())}`
            });
            await loadEntries(user.id);
        }
        
        localStorage.removeItem("meri_creator_session_start");
        localStorage.removeItem("meri_creator_session_type");

        document.getElementById("creatorWithBtn").disabled = false;
        document.getElementById("creatorNoBtn").disabled = false;
        document.getElementById("creatorStopBtn").disabled = true;
        document.getElementById("creatorStatus").textContent = "No active session.";
        document.getElementById("miniTimer").textContent = "00:00";
    }


    async function setupAfterLogin(){
      const user=await getCurrentUser();if(!user)return;
      document.getElementById("authSection").style.display="none";
      const saved=localStorage.getItem("meri_selected_date");
      if(saved){
        const d=new Date(saved);
        window.currentDate=d;
        document.getElementById("selectedDateHeader").textContent=`${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
        document.getElementById("mainApp").style.display="block";
        setupDaily();
      } else {
        document.getElementById("dateSelectorPage").style.display="block";
        buildDateSelector();
      }
      // Re-check creator session state on refresh
      if (localStorage.getItem("meri_creator_session_start")) {
          creatorStartTime = new Date(localStorage.getItem("meri_creator_session_start"));
          const type = localStorage.getItem("meri_creator_session_type");
          document.getElementById("creatorWithBtn").disabled = true;
          document.getElementById("creatorNoBtn").disabled = true;
          document.getElementById("creatorStopBtn").disabled = false;
          document.getElementById("creatorStatus").textContent = `Session Active: ${type === 'social' ? 'With Social' : 'No Social'}`;
          creatorSessionInterval = setInterval(updateMiniTimer, 1000);
      }
    }

    window.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("mainApp").style.display = "none";
      document.getElementById("dateSelectorPage").style.display = "none";

      const { data: { session } } = await supabase.auth.getSession();
      document.getElementById("authForm").addEventListener("submit", handleAuth);
      document.getElementById("logoutBtn").addEventListener("click", handleLogout);
      
      // Clock In/Out Listeners
      document.getElementById("clockInBtn").addEventListener("click", handleClockIn);
      document.getElementById("clockOutBtn").addEventListener("click", handleClockOut);

      // Creator Session Listeners
      document.getElementById("creatorWithBtn").addEventListener("click", () => startCreator('social'));
      document.getElementById("creatorNoBtn").addEventListener("click", () => startCreator('no-social'));
      document.getElementById("creatorStopBtn").addEventListener("click", stopCreator);
      
      // Initialize the clock interval
      setInterval(tickClock, 1000);

      if (!session?.user) {
          document.getElementById("authSection").style.display = "block";
          return;
      }
      
      await setupAfterLogin();
    });
  </script>
</head>

<body>
  <div class="container">
    <div id="authSection" class="card">
      <div class="section-title">Log in or Sign up</div>
      <form id="authForm" class="form">
        <input type="email" id="authEmail" placeholder="Email" required />
        <input type="password" id="authPassword" placeholder="Password" required />
        <button class="btn primary" type="submit">Continue</button>
      </form>
    </div>

    <div id="dateSelectorPage" class="date-selector">
      <h2>Select Date</h2>
      <div id="dateSelector"></div>
    </div>

    <div id="mainApp">
      <div class="controls">
        <button id="logoutBtn" class="btn ghost">Log out</button>
        <button id="exportBtn" class="btn primary">Export CSV (Pending)</button>
        <button id="clearBtn" class="btn ghost">Clear All (Pending)</button>
      </div>

      <h2 id="selectedDateHeader" style="text-align:center;margin-top:10px;"></h2>

            <div class="card">
        <div class="section-title">Flip Clock</div>
                <div class="clock"></div>
      </div>

            <div class="card">
        <div class="section-title">Clock In / Clock Out</div>
        <form class="form" onsubmit="return false;">
          <input type="text" id="activity" placeholder="What are you doing?" required />
          <select id="category">
            <option value="">No tag</option>
            <option>Study</option>
            <option>Work</option>
            <option>Gym</option>
            <option>Deep Work</option>
            <option>Content</option>
            <option>Admin</option>
          </select>
          <textarea id="notes" placeholder="Notes (optional)"></textarea>
          <button id="clockInBtn" class="btn success" type="button">Clock In</button>
          <button id="clockOutBtn" class="btn warn" type="button" disabled>Clock Out</button>
        </form>
        <div id="clockInStatus" style="margin-top:10px; color:var(--muted);">Not currently clocked in.</div>
      </div>

  <div class="card">
  <div class="section-title">Entries</div>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Start</th>
        <th>End</th>
        <th>Duration</th>         <th>Activity</th>
        <th>Tag</th>
        <th>Notes</th>
      </tr>
    </thead>
    <tbody id="entriesBody">
          </tbody>
  </table>
</div>

<div class="card">
  <div class="section-title">Focus Zone — Creator Sessions & 30-min Checks</div>
  <div class="form" style="align-items:center;">
    <button id="creatorWithBtn" class="btn primary" type="button">Start Creator (With Social)</button>
    <button id="creatorNoBtn" class="btn success" type="button">Start Creator (No Social)</button>
    <button id="creatorStopBtn" class="btn warn" type="button" disabled>Stop</button>
    <span style="margin-left:10px;">Session Timer: <span id="miniTimer" class="mini-timer">00:00</span></span>
  </div>

  <div class="status" id="creatorStatus" style="margin-top:6px;">No active session.</div>

  <div id="slotsGrid"
       style="display:grid;
              grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
              gap:8px;
              margin-top:12px;">
      </div>
</div>
</div> </div> </body>
</html>

